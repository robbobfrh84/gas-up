<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title> 02-google-sheets-DB: Show All </title>
  <style> td { border: 1px solid; padding: 3px;} </style>
</head>
<body>
  <h1> Google Sheets as public DB </h1>
  Included: <br>
  &bull; Sheets' data display in an individual html <code>&#60;table&#62;</code> <br>
  &bull; All "sheets" within Google Sheet <br>
  &bull; JSON to clean data structure with all sheets included (global object saved as"_sheets") <br>
  &star; See Console for object of sheets (option+command+j) <br>
  <hr>
  <div id='tables'></div>
</body>
</html>
<script>

// - - - - - - - - - - - ðŸ‘‡        YOUR SHEETS SCRIPT ID HERE          ðŸ‘‡
const _google_script_id = "1y3sqWKW1DwmLR-4HtA1e56rhd8y3rSs1KhtpsCjcFtU"
var _sheets = {}

window.onload = ()=>{
  const _url = "https://spreadsheets.google.com/feeds"
  const _url_end = "/public/values?alt=json"
  _GET(_url+"/worksheets/"+_google_script_id+_url_end)
    .then(payload => _get_all_sheets(JSON.parse(payload.responseText).feed.entry))
}

_get_all_sheets = (data)=>{

  clean = (data, name)=>{
    let flatData = []
    for (field in data[0]) {
      const key = field.split('gsx$')[1]
      if (key) {
        for (let i = 0; i < data.length; i++) {
          if (!flatData[i]) flatData[i] = {}
          flatData[i][key] = data[i][field]['$t']
        }
      }
    }
    _sheets[name] = flatData
  }

  let sheetsPromise = []
  let sheetOrder = []

  for (const sheet of data) {
    _sheets[sheet.content.$t]
    sheetOrder.push(sheet.content.$t)
    sheetsPromise.push(new Promise(function(resolve, reject) {
      _GET(sheet.link[0].href+"?alt=json")
        .then(payload => clean(JSON.parse(payload.responseText).feed.entry, sheet.content.$t))
        .then(resolve)
    }))
  }

  Promise.all(sheetsPromise)
    .then(x => _show_all_sheets(_sheets, sheetOrder))
    .then(x => console.log('All sheets object ðŸ‘‡ \n _sheets:', _sheets))
}

_show_all_sheets = (data, order)=>{
  const tables = document.getElementById('tables')
  for (const i in order) {
    tables.innerHTML += `
      <h3>Sheet Name: ${order[i]}</h3>
      <table id='dynamic-table-${order[i]}'>
        <tr id='dynamic-headers-${order[i]}'></tr>
      </table> <br>
    `
    const headers = document.getElementById("dynamic-headers-"+order[i])
    const table = document.getElementById("dynamic-table-"+order[i])
    for (const header in data[order[i]][0]) {
      headers.innerHTML += `
        <th>${header}</th>
      `
    }
    data[order[i]].map((row,ii)=>{
      table.innerHTML += `<tr id='row-${order[i]}-${ii}'></tr>`
      const tdRow = document.getElementById('row-'+order[i]+'-'+ii)
      for (val in row) {
        tdRow.innerHTML += `
         <td> ${row[val]} </td>
        `
      }
    })
  }
}

_GET = (url)=>{
  return new Promise((res, rej) => {
    let xhr = new XMLHttpRequest()
    xhr.open('GET', url, true)
    xhr.onreadystatechange = function () {
      if (this.readyState == 4) {
        if (this.status == 200) res(xhr)
        else rej(xhr)
      }
    }
    xhr.send(null)
  })
}

</script>
